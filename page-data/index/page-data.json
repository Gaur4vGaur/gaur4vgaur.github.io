{"componentChunkName":"component---src-templates-index-js","path":"/","result":{"data":{"site":{"siteMetadata":{"title":"Code Thoughts","subtitle":"Everything Should Be Made As Simple As Possible, But Not Simpler -Albert Einstein","author":"Gaurav Gaur","bio":""}},"allMarkdownRemark":{"edges":[{"node":{"excerpt":"Introduction In my previous article we established that microbenchmarking is hard with . It is not enough to surround the code in a loopâ€¦","fields":{"slug":"/java/java-benchmarking-jmh/","readingTime":{"text":"6 min read"}},"html":"<h3>Introduction</h3>\n<p>In my <a href=\"/java/java-benchmarking\" target=\"_blank\">previous article</a> we established that microbenchmarking is hard with <code class=\"language-text\">jvm</code>. It is not enough to surround the code in a loop with <code class=\"language-text\">System.out.println()</code> and gather the time measurements. While benchmarking, a developer should consider warm-up cycles, JIT compilations, jvm optimizations, avoiding usual pitfalls and even more.</p>\n<p>Thankfully, OpenJDK has a great tool Java Microbenchmark Harness (JMH) that can help us generated benchmarking stats. In this article we will discuss how JMH can help us avoid the pitfalls that we have <a href=\"/java/java-benchmarking\" target=\"_blank\">discussed earlier</a>. </p>\n<h3>Getting Started with JMH</h3>\n<p>A quick way to start with JMH is to use the Maven archetype. The command below will generate a new Java project <code class=\"language-text\">benchmark</code>. The project will have <code class=\"language-text\">com/gaurav/MyBenchmark.java</code> class and <code class=\"language-text\">pom.xml</code>. The Maven <code class=\"language-text\">pom.xml</code> includes all the required dependencies to support JMH.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"shell\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mvn archetype:generate -DarchetypeGroupId=org.openjdk.jmh -DarchetypeArtifactId=jmh-java-benchmark-archetype -DinteractiveMode=false -DgroupId=com.gaurav -DartifactId=benchmark -Dversion=1.0</span></span></code></pre>\n<h3>Good Benchmarks with JMH</h3>\n<p>Let us discuss how JMH can help us to write better microbencharmks.</p>\n<ul>\n<li>JMH by default makes several warm up cycles before collecting the stats. Thus, it makes sure that the results are not completely random and <code class=\"language-text\">jvm</code> has performed optimizations.</li>\n<li><code class=\"language-text\">@benchmark</code> runs iteration over the code, and then collects the average. The more runs you make through the code, the better stats you will collect.</li>\n<li>Use <a href=\"http://javadox.com/org.openjdk.jmh/jmh-core/1.6.3/org/openjdk/jmh/infra/Blackhole.html\" target=\"_blank\"><code class=\"language-text\">Blackhole</code></a> class of JMH can avoid deal code elimination by <code class=\"language-text\">jvm</code>. If you pass the calculated results to <code class=\"language-text\">blackhole.consume()</code>, it would trick the <code class=\"language-text\">jvm</code>. <code class=\"language-text\">jvm</code> will never drop the code, thinking that <code class=\"language-text\">consume()</code> method uses the result.</li>\n</ul>\n<h3>Writing First Benchmark</h3>\n<p>Maven has already provided with us a template in <code class=\"language-text\">MyBenchmark</code> class to fill in. I am going to utilise the same class.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">package</span><span class=\"mtk1\"> </span><span class=\"mtk7\">com.gaurav</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">import</span><span class=\"mtk1\"> </span><span class=\"mtk7\">org.openjdk.jmh.annotations.Benchmark</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">MyBenchmark</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">Benchmark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk5\">testMethod</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// This is a demo/sample template for building your JMH benchmarks. Edit as needed.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk3\">// Put your benchmark code here.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>I would like to keep my first benchmark pretty simple. Let us start by iterating over all the elements of a list and sum them up using a conventional <code class=\"language-text\">for</code> loop. As discussed, I will use <code class=\"language-text\">Blackhole</code> to fool the compiler and return the result. Here, I am asking JMH to calculate the average time, using <code class=\"language-text\">@BenchmarkMode</code>, it takes to run the <code class=\"language-text\">testMethod()</code>.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">Benchmark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">BenchmarkMode</span><span class=\"mtk1\">(Mode.AverageTime)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> </span><span class=\"mtk5\">testMethod</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">Blackhole</span><span class=\"mtk1\"> blackhole) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> sum </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i</span><span class=\"mtk7\">=</span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i</span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\">list.</span><span class=\"mtk5\">size</span><span class=\"mtk1\">(); i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sum </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> list.</span><span class=\"mtk5\">get</span><span class=\"mtk1\">(i);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        blackhole.</span><span class=\"mtk5\">consume</span><span class=\"mtk1\">(sum);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> sum;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3>Compiling the JMH Project</h3>\n<p>You can compile and build the project like any other Maven project, using below Maven command:</p>\n<pre class=\"grvsc-container monokai\" data-language=\"shell\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">mvn clean install</span></span></code></pre>\n<p>The command will create a fully executable <code class=\"language-text\">jar</code> file under <code class=\"language-text\">benchmark/target</code> directory. Please note that Maven will always generate a <code class=\"language-text\">jar</code> file named <code class=\"language-text\">benchmarks.jar</code>, regardless of the project name.</p>\n<p>Next step is to execute the <code class=\"language-text\">jar</code> using below command:</p>\n<pre class=\"grvsc-container monokai\" data-language=\"shell\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">java -jar target/benchmarks.jar</span></span></code></pre>\n<p>It produced the below result for me. It means that test operation is taking approx. <em>0.053</em> seconds on the current hardware.  </p>\n<pre class=\"grvsc-container monokai\" data-language=\"shell\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"># Run progress: 80.00% complete, ETA 00:01:41</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Fork: 5 of 5</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Warmup Iteration   1: 0.052 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Warmup Iteration   2: 0.051 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Warmup Iteration   3: 0.053 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Warmup Iteration   4: 0.056 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Warmup Iteration   5: 0.055 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Iteration   1: 0.054 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Iteration   2: 0.053 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Iteration   3: 0.053 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Iteration   4: 0.054 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Iteration   5: 0.059 s/op</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">Result &quot;com.example.MyBenchmark.testMethod&quot;:</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  0.053 Â±(99.9%) 0.002 s/op [Average]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  (min, avg, max) = (0.052, 0.053, 0.061), stdev = 0.002</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  CI (99.9%): [0.051, 0.055] (assumes normal distribution)</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"># Run complete. Total time: 00:08:27</span></span></code></pre>\n<h3>Benchmark Modes</h3>\n<p>In the previous example, I used <code class=\"language-text\">@BenchmarkMode(Mode.AverageTime)</code>. If you try to decompile JMH jar, you will find <code class=\"language-text\">enum Mode</code> with below values:</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Modes</th>\n<th align=\"center\"></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"left\"><code class=\"language-text\">Throughput(&quot;thrpt&quot;, &quot;Throughput, ops/time&quot;)</code></td>\n<td align=\"center\">It will calculate the number of times your method can be executed with in a second</td>\n</tr>\n<tr>\n<td align=\"left\"><code class=\"language-text\">AverageTime(&quot;avgt&quot;, &quot;Average time, time/op&quot;)</code></td>\n<td align=\"center\">It will calculate the average time in seconds to execute the test method</td>\n</tr>\n<tr>\n<td align=\"left\"><code class=\"language-text\">SampleTime(&quot;sample&quot;, &quot;Sampling time&quot;)</code></td>\n<td align=\"center\">It randomly samples the time spent in test method calls</td>\n</tr>\n<tr>\n<td align=\"left\"><code class=\"language-text\">SingleShotTime(&quot;ss&quot;, &quot;Single shot invocation time&quot;)</code></td>\n<td align=\"center\">It works on single invocation of the method and is useful in calculating <em>cold</em> performance</td>\n</tr>\n<tr>\n<td align=\"left\"><code class=\"language-text\">All(&quot;all&quot;, &quot;All benchmark modes&quot;)</code></td>\n<td align=\"center\">Calculates all of the above</td>\n</tr>\n</tbody>\n</table>\n<p>The default Mode is <code class=\"language-text\">Throughput</code></p>\n<h3>Time measurement</h3>\n<p>It is evident from the console output above that calculations are in seconds. But, JMH allows you to configure the time units, using <code class=\"language-text\">@OutputTimeUnit</code> annotation. The <code class=\"language-text\">@OutputTimeUnit</code> accepts <code class=\"language-text\">java.util.concurrent.TimeUnit</code>, as shown below:</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk9 mtki\">OutputTimeUnit</span><span class=\"mtk1\">(TimeUnit.SECONDS)</span></span></span></code></pre>\n<p>The <code class=\"language-text\">TimeUnit</code> enum has following values:</p>\n<p>NANOSECONDS<br>\nMICROSECONDS<br>\nMILLISECONDS<br>\nSECONDS<br>\nMINUTES<br>\nHOURS<br>\nDAYS<br></p>\n<p>The default <code class=\"language-text\">TimeUnit</code> is <code class=\"language-text\">SECONDS</code></p>\n<h3>Configure Fork, Warmup and Iterations</h3>\n<p>The benchmark is currently executing 5 times, with 5 warmup iterations and 5 measurement iterations. JMH even allows to configure these values using <code class=\"language-text\">@Fork</code>, <code class=\"language-text\">@Warmup</code> and <code class=\"language-text\">@Measurement</code> annotations. The code snippet below would execute the test method twice, with a couple of warmup iterations and 3 measurement iterations.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk9 mtki\">Fork</span><span class=\"mtk1\">(</span><span class=\"mtk4\">value</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk9 mtki\">Warmup</span><span class=\"mtk1\">(</span><span class=\"mtk4\">iterations</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">2</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">@</span><span class=\"mtk9 mtki\">Measurement</span><span class=\"mtk1\">(</span><span class=\"mtk4\">iterations</span><span class=\"mtk1\"> </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">3</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p><code class=\"language-text\">@Warmup</code> and <code class=\"language-text\">@Measurement</code> annotations also accepts parameters:</p>\n<ul>\n<li><code class=\"language-text\">batchSize</code> - configures the number of test method calls to be performed per operation</li>\n<li><code class=\"language-text\">time</code> - time spent for each iteration</li>\n</ul>\n<h3>Practice</h3>\n<p>You can play around to compare execution times of different <code class=\"language-text\">for</code> loops i.e. a conventional <code class=\"language-text\">for</code> loop, a <code class=\"language-text\">forEach</code> loop and a <code class=\"language-text\">stream</code> iterator. Something like:</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">private</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk7\">final</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">List</span><span class=\"mtk1\">&lt;</span><span class=\"mtk9 mtki\">Integer</span><span class=\"mtk1\">&gt; list </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> IntStream.</span><span class=\"mtk5\">rangeClosed</span><span class=\"mtk1\">(</span><span class=\"mtk4\">1</span><span class=\"mtk1\">, Integer.MAX_VALUE</span><span class=\"mtk7\">/</span><span class=\"mtk4\">100</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            .</span><span class=\"mtk5\">boxed</span><span class=\"mtk1\">().</span><span class=\"mtk5\">collect</span><span class=\"mtk1\">(Collectors.</span><span class=\"mtk5\">toList</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">Benchmark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">BenchmarkMode</span><span class=\"mtk1\">(Mode.AverageTime)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> </span><span class=\"mtk5\">conventionalLoop</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">Blackhole</span><span class=\"mtk1\"> blackhole) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> sum </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i</span><span class=\"mtk7\">=</span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i</span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\">list.</span><span class=\"mtk5\">size</span><span class=\"mtk1\">(); i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sum </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> list.</span><span class=\"mtk5\">get</span><span class=\"mtk1\">(i);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        blackhole.</span><span class=\"mtk5\">consume</span><span class=\"mtk1\">(sum);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> sum;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">Benchmark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">BenchmarkMode</span><span class=\"mtk1\">(Mode.AverageTime)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> </span><span class=\"mtk5\">enhancedForLoop</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">Blackhole</span><span class=\"mtk1\"> blackhole) throws InterruptedException {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> sum </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> integer </span><span class=\"mtk7\">:</span><span class=\"mtk1\"> list) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sum </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> integer;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        blackhole.</span><span class=\"mtk5\">consume</span><span class=\"mtk1\">(sum);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> sum;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">Benchmark</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    @</span><span class=\"mtk9 mtki\">BenchmarkMode</span><span class=\"mtk1\">(Mode.AverageTime)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> </span><span class=\"mtk5\">streamMap</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">Blackhole</span><span class=\"mtk1\"> blackhole) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">double</span><span class=\"mtk1\"> sum </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> list.</span><span class=\"mtk5\">stream</span><span class=\"mtk1\">().</span><span class=\"mtk5\">mapToDouble</span><span class=\"mtk1\">(Integer</span><span class=\"mtk7\">::</span><span class=\"mtk1\">doubleValue).</span><span class=\"mtk5\">sum</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        blackhole.</span><span class=\"mtk5\">consume</span><span class=\"mtk1\">(sum);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> sum;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span></code></pre>\n<h3>Conclusion</h3>\n<p>In this article we have gone through a hands-on example of creating a JMH project. We have seen how can we configure our JMH project to suit our needs. You can refer to <a href=\"https://github.com/openjdk/jmh/tree/master/jmh-samples/src/main/java/org/openjdk/jmh/samples\" target=\"_blank\">JMH Github Samples</a> for more in depth examples.</p>\n<p>We have seen that JMH is a <code class=\"language-text\">jvm</code> tool. In the next article we will try to explore if it can help us with other <code class=\"language-text\">jvm</code> based languages.</p>\n<p><strong>Reference</strong><br>\n<sup><a href=\"https://github.com/openjdk/jmh\" target=\"_blank\">JMH Github</a></sup><br>\n<sup><a href=\"https://github.com/openjdk/jmh/tree/master/jmh-samples/src/main/java/org/openjdk/jmh/samples\" target=\"_blank\">JMH Github Samples</a></sup><br>\n<sup><a href=\"http://javadox.com/org.openjdk.jmh/jmh-core/0.8/org/openjdk/jmh/annotations/Mode.html\" target=\"_blank\">JMH Javadocs - Mode</a></sup><br>\n<sup><a href=\"http://javadox.com/org.openjdk.jmh/jmh-core/1.7/org/openjdk/jmh/annotations/OutputTimeUnit.html\" target=\"_blank\">JMH Javadocs - OutputTimeUnit</a></sup><br>\n<sup><a href=\"http://javadox.com/org.openjdk.jmh/jmh-core/0.9/org/openjdk/jmh/annotations/Fork.html\" target=\"_blank\">JMH Javadocs - Fork</a></sup><br></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk3 { color: #75715E; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Java Microbenchmark Harness (JMH)","date":"April 10, 2021","subtitle":"Creating the first JMH project","description":"A quick hands-on lesson to learn about Java Microbenchmark Harness (JMH). The article helps you get started and configure JMH project."}}},{"node":{"excerpt":"Introduction Optimisation of code is an endless struggle. It is often even hard to produce meaningful metrics using  as it is an adaptiveâ€¦","fields":{"slug":"/java/java-benchmarking/","readingTime":{"text":"6 min read"}},"html":"<h3>Introduction</h3>\n<p>Optimisation of code is an endless struggle. It is often even hard to produce meaningful metrics using <code class=\"language-text\">jvm</code> as it is an adaptive virtual machine. The article is</p>\n<ul>\n<li>a brief introduction to microbenchmarking,</li>\n<li>why microbenchmark</li>\n<li>when to consider it, and finally,</li>\n<li>pitfalls to avoid</li>\n</ul>\n<h3>What is a Microbenchmark</h3>\n<p>A microbenchmark is an attempt to measure the performance of a small unit of code. The tests are usually in the sub-millisecond range. The tests can help determine how the code is going to behave when released into production. These tests are guide to a better implementation.</p>\n<h3>Why Microbenchmark</h3>\n<p>Profiling a whole app in a production or production-like environment is difficult. Profiling cannot pinpoint a specific piece of code. Moreover, it also counts external factors such as logging. Yet, profiling does produce realistic results.</p>\n<p>Micro-benchmarking focuses on a specific piece of code, removing everything else. But, you need to be careful of the results produced by benchmarking, as these are somewhat artificial.</p>\n<p>If we are asking JVM to manage a small piece of code, it means we are asking JVM to handle a different problem. JVM may optimize the code differently from that in production. GC may be much more effective for this small program, but it can take long pauses in actual production application. Besides, the machine architecture of the production server could be completely different from the local machine used for benchmarking.</p>\n<p><strong>Why should I benchmark then?</strong><br>\nUsually, it should be the job of <code class=\"language-text\">jvm</code> to optimize the code. As a good practice, a developer should only focus on principles of clean coding. But it is always a good idea to review the code. You should consider asking can I break this loop early, or can I reduce the complexity of an algorithm?</p>\n<h3>When to Consider Microbenchmark</h3>\n<p>A developer should test an application in a way it is supposed to be used, with a similar kind of inputs. But, it might not be possible every time. For example, if you are trying to write an underlying support infrastructure for a variety of applications, or if you are producing a library. Thus, it is not possible to predict the range of inputs or to monitor and optimize the code for specific scenarios. In these scenarios, you can consider benchmarking.\nMicro benchmarking may still not provide definitive answers to problems you may face, but, it can point towards a better design. </p>\n<h3>Code to Microbenchmark</h3>\n<p>Let us try to microbenchmark a piece of code. I am going to write a program to calculate nth Narcissistic number or a plus perfect number. If you have never heard about these numbers then you can refer to <a href=\"https://en.wikipedia.org/wiki/Narcissistic_number\">Wikipedia</a>. These are the numbers where the number is equal to the sum of its own digits each raised to the power of the number of digits.</p>\n<p>The first step is to define <code class=\"language-text\">isNarNumber()</code> that would check if a provided number is a Narcissistic number.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">NarcissisticNumber</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">boolean</span><span class=\"mtk1\"> </span><span class=\"mtk5\">isNarNumber</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">number</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> length </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> String.</span><span class=\"mtk5\">valueOf</span><span class=\"mtk1\">(number).</span><span class=\"mtk5\">length</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> sum </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> number; i </span><span class=\"mtk7\">&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">/</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            sum </span><span class=\"mtk7\">+=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">pow</span><span class=\"mtk1\">(i </span><span class=\"mtk7\">%</span><span class=\"mtk1\"> </span><span class=\"mtk4\">10</span><span class=\"mtk1\">, length);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> sum </span><span class=\"mtk7\">==</span><span class=\"mtk1\"> number;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>Next step is to define the method <code class=\"language-text\">findNarcissisticNumber()</code> to get the results</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">NarcissisticNumber</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> </span><span class=\"mtk5\">findNarcissisticNumber</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> </span><span class=\"mtk10 mtki\">n</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> pointer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (i</span><span class=\"mtk7\">=</span><span class=\"mtk4\">1</span><span class=\"mtk1\">; i</span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\">Integer.MAX_VALUE </span><span class=\"mtk7\">&amp;&amp;</span><span class=\"mtk1\"> pointer </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> n; i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk7\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk5\">isNarNumber</span><span class=\"mtk1\">(i)) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">                pointer </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> pointer</span><span class=\"mtk7\">+</span><span class=\"mtk4\">1</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">return</span><span class=\"mtk1\"> i;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h3>A Naive Approach</h3>\n<p>The concept of benchmarking seems straight. I can quickly measure the execution time of <code class=\"language-text\">findNarcissisticNumber</code> by using <code class=\"language-text\">System.currentTimeMillis()</code>.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">NarcissisticNumber</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk7\">public</span><span class=\"mtk1\"> </span><span class=\"mtk7\">static</span><span class=\"mtk1\"> </span><span class=\"mtk9 mtki\">void</span><span class=\"mtk1\"> </span><span class=\"mtk5\">main</span><span class=\"mtk1\">(</span><span class=\"mtk9 mtki\">String</span><span class=\"mtk1\">[] </span><span class=\"mtk10 mtki\">args</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> result;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">long</span><span class=\"mtk1\"> before </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> System.</span><span class=\"mtk5\">currentTimeMillis</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> cycles; i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">findNarcissisticNumber</span><span class=\"mtk1\">(</span><span class=\"mtk4\">20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk9 mtki\">long</span><span class=\"mtk1\"> after </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> System.</span><span class=\"mtk5\">currentTimeMillis</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        System.out.</span><span class=\"mtk5\">println</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;Time elapsed: &quot;</span><span class=\"mtk1\"> </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> (after</span><span class=\"mtk7\">-</span><span class=\"mtk1\">before)</span><span class=\"mtk7\">/</span><span class=\"mtk1\">cycles </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> </span><span class=\"mtk6\">&quot; seconds&quot;</span><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>But, the approach might not be best suited with jvm. There are few common pitfalls with the approach above. We will discuss the same in next section.</p>\n<h3>Avoid Common Pitfalls</h3>\n<p><code class=\"language-text\">jvm</code>  is quite advanced, and it can optimize the code itself. The features of <code class=\"language-text\">jvm</code> such as JIT compilation and garbage collection makes it hard to perform bencharmking. I am listing a few of the pitfalls, if are not considered, then may lead to inconsistent results.</p>\n<h4>1. Skipping Warm-up Cycles</h4>\n<p><code class=\"language-text\">jvm</code> optimizes the code with each run. The code execution gets faster, the longer it is executed. Skipping <code class=\"language-text\">jvm</code> warm-up will lead to inconsistent reading. Thus, benchmarking should include warm-up cycles to allow <code class=\"language-text\">jvm</code> to optimize the code. </p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> warmupCycles; i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">findNarcissisticNumber</span><span class=\"mtk1\">(</span><span class=\"mtk4\">20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk7\">for</span><span class=\"mtk1\"> (</span><span class=\"mtk9 mtki\">int</span><span class=\"mtk1\"> i </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">0</span><span class=\"mtk1\">; i </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> cycles; i</span><span class=\"mtk7\">++</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    result </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">findNarcissisticNumber</span><span class=\"mtk1\">(</span><span class=\"mtk4\">20</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h4>2. Dead Code</h4>\n<p>Even after considering the warm-up cycles, it is possible that execution time is reported as 0. Since <code class=\"language-text\">result</code> is not used anywhere <code class=\"language-text\">jvm</code> can skip the loop altogether. It is also possible that the compiler performs partial iterations, thus, leading to even more inconsistent result.  To fix the issue it is better to read it is advisable to read the result.</p>\n<h4>3. Not Testing a Range of Input</h4>\n<p>Even if the code starts using the <code class=\"language-text\">result</code> variable, we may still get irregular readings. The code above always calculates the 20th Narcissistic number. A smart compiler can figure that out and can replace the method call with the constant result. The iterations are redundant, and the compiler can skip a few of those.</p>\n<p>Moreover, the code in production would calculate the Narcissistic number on a range of inputs. Hence, we should also benchmark the code with a similar range of inputs.</p>\n<h4>4. Noisy Neighbours</h4>\n<p>While running benchmarking on the machine, you might not be aware of all the processes running your system. It is possible to have background apps contending for CPU and RAM on the local machine. Thus, creating a server like environment is difficult.  Mitigating the noisy neighbour problem is a bit tricky.</p>\n<h3>Conclusion</h3>\n<p>It is difficult to achieve good benchmarking stats. We need to consider all the factors if we want to achieve reliable results. The article highlights the pitfalls of benchmarking. In the next post, we will explore Java Microbenchmark Harness (jmh). JMH is a powerful tool and can help us to benchmark the code.</p>\n<p><strong>Reference</strong><br>\n<sup><a href=\"https://github.com/openjdk/jmh\" target=\"_blank\">JMH Github</a></sup><br>\n<sup><a href=\"https://shipilev.net/talks/devoxx-Nov2013-benchmarking.pdf\" target=\"_blank\">Devoxx-Nov2013 Slides</a></sup><br>\n<sup><a href=\"https://github.com/google/caliper/wiki/JavaMicrobenchmarks\" target=\"_blank\">Google Caliper Github</a></sup><br>\n<sup><a href=\"https://www.oracle.com/technical-resources/articles/java/architect-benchmarking.html\" target=\"_blank\">Oracle Avoiding Benchmarking Pitfalls on the JVM</a></sup></p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtki { font-style: italic; }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk9 { color: #66D9EF; }\n  .monokai .mtk10 { color: #FD971F; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"What is Microbenchmarking","date":"March 30, 2021","subtitle":"Microbenchmarking with jvm is hard and should be avoided","description":"An introduction to Microbenchmarking, when to use it and pitfalls to avoid."}}},{"node":{"excerpt":"One of the most common ADT that a developer uses in their day-to-day coding is List. And one of the most common operations a developerâ€¦","fields":{"slug":"/scala/sorting-lists-of-objects/","readingTime":{"text":"2 min read"}},"html":"<p>One of the most common ADT that a developer uses in their day-to-day coding is List. And one of the most common operations a developer performs on a list is to order it or sort it with given criteria. In this article, I will focus on sorting a list of objects in Scala.</p>\n<p>Mainly, there are two ways of sorting a list in Scala, i.e.</p>\n<ul>\n<li><code class=\"language-text\">sortWith</code></li>\n<li><code class=\"language-text\">sortBy</code></li>\n</ul>\n<p>Letâ€™s consider the popular example of sorting IMDB ratings. Below is my IMDB class.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">case </span><span class=\"mtk7\">class</span><span class=\"mtk1\"> </span><span class=\"mtk5 mtku\">ImdbRating</span><span class=\"mtk1\">(name: String, ratings: Double)</span></span></span></code></pre>\n<p>Here is a list of the top five rated movies of all time (source).</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val ratings </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk5\">List</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">ImdbRating</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;The Shawshank Redemption&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">9.3</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">ImdbRating</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;The Godfather &quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">9.2</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">ImdbRating</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;The Dark Knight&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">9.1</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">ImdbRating</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;The Godfather: Part II&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">9.0</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk5\">ImdbRating</span><span class=\"mtk1\">(</span><span class=\"mtk6\">&quot;The Lord of the Rings: The Return of the King&quot;</span><span class=\"mtk1\">, </span><span class=\"mtk4\">8.9</span><span class=\"mtk1\">)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>If you observe closely, the above list is ordered by ratings, but my requirement is to order movies by length of their names.</p>\n<h3>sortWith</h3>\n<p>First, I will try to order the list using <code class=\"language-text\">sortWith</code>. <code class=\"language-text\">sortWith</code> sorts a given list based on the comparison function that is provided to it. It is a stable sort, which means that an item will not lose its original position if two elements are equal. Here is the code to sort the list by length of names:</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val sortedRatings </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ratings.</span><span class=\"mtk5\">sortWith</span><span class=\"mtk1\">(_.name.size </span><span class=\"mtk7\">&lt;</span><span class=\"mtk1\"> _.name.size)</span></span></span></code></pre>\n<p>If I want to order the list in descending order, then all I need to do is to reverse the <code class=\"language-text\">&lt;</code> operator. </p>\n<h3>sortBy</h3>\n<p>Another way to order the above list is to use <code class=\"language-text\">sortBy</code>. <code class=\"language-text\">sortBy</code> sorts a given sequence according to the implicitly defined natural <code class=\"language-text\">Ordering</code>. Like <code class=\"language-text\">sortWith</code>, this sort is stable as well. Here is the code to order the list.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val sortedRatings </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> ratings.</span><span class=\"mtk5\">sortBy</span><span class=\"mtk1\">(_.name.size)</span></span></span></code></pre>\n<p>There is a third way to sort the list of objects that I have not discussed here, and that is to extend the <code class=\"language-text\">Ordered</code> trait. The trait forces you to implement the <code class=\"language-text\">compare</code> method. <code class=\"language-text\">Ordered</code> trait is somewhat like <code class=\"language-text\">Comparable</code> interfaces in java.</p>\n<p>If you want more details about sorting or Ordered trait, you can refer to the following videos in which I provide additional examples.</p>\n<iframe src=\"https://www.youtube.com/embed/hjY_mC7dPxc\"></iframe>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtku {\n    text-decoration: underline;\n    text-underline-position: under;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk6 { color: #E6DB74; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Sorting Lists of Objects in Scala","date":"November 14, 2019","subtitle":"How to best sort lists in Scala.","description":"Learn how to set sort the lists in Scala. The blog talks about the usage of sortWith and sortBy along with coding examples"}}},{"node":{"excerpt":"Similar to Java, Scala also supports variable arguments or repeated method parameters. The concept is really useful in situations when youâ€¦","fields":{"slug":"/scala/scala-repeated-method-parameters/","readingTime":{"text":"2 min read"}},"html":"<p>Similar to Java, Scala also supports variable arguments or repeated method parameters. The concept is really useful in situations when you donâ€™t know how many parameters you need to pass to a method, or you have to pass an unlimited number of arguments to a method.</p>\n<p>However, there are few conditions to using repeated method parameters in Scala</p>\n<ul>\n<li>All the repeated parameters must be of the same type.</li>\n<li>We can only have one argument as a repeated parameter in the method definition. We cannot declare 2 repeated parameters for a method.</li>\n<li>Scala only allows the last parameter of the method call to be repeated.</li>\n</ul>\n<p>To denote a repeated parameter, place an asterisk after the type of the parameter. For example, below is a sum method that would calculate the sum of all the numbers passed to the method.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">def </span><span class=\"mtk5\">sum</span><span class=\"mtk1\">(args</span><span class=\"mtk7\">:</span><span class=\"mtk1\"> Int</span><span class=\"mtk7\">*</span><span class=\"mtk1\">)</span><span class=\"mtk7\">:</span><span class=\"mtk1\"> Int </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> args.</span><span class=\"mtk5\">fold</span><span class=\"mtk1\">(</span><span class=\"mtk4\">0</span><span class=\"mtk1\">)(_</span><span class=\"mtk7\">+</span><span class=\"mtk1\">_)</span></span></span></code></pre>\n<p>You can call sum as <code class=\"language-text\">sum()</code> or <code class=\"language-text\">sum(3,4)</code> or <code class=\"language-text\">sum(1,3,4,5,7,8,9)</code>. Scala treats incoming parameters as arrays. However, if you try to pass an array to <code class=\"language-text\">sum()</code>, Scala will throw a type mismatch error.</p>\n<pre class=\"grvsc-container grvsc-has-line-highlighting monokai\" data-language=\"shell\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">scala&gt; sum(Array(1,2))</span></span>\n<span class=\"grvsc-line grvsc-line-highlighted\"><span class=\"grvsc-source\">&lt;console&gt;:13: error: type mismatch</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> found   : Array[Int]</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"> required: Int</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">       sum(Array(1,2))</span></span></code></pre>\n<p>In order to pass an array, we need to append the argument with a colon and an<code class=\"language-text\">_*</code> symbol.</p>\n<p>This notation will ask the compiler to pass each element of the array as a single argument. So array elements are passed one by one to <code class=\"language-text\">sum()</code>, rather than all of it as a single argument.</p>\n<p>The video tutorial talks about the same concepts in more detail and provides few more examples.</p>\n<iframe src=\"https://www.youtube.com/embed/tyHswiV2gvk?list=PLiRMk2ipn1vqwRMy6NhroeQOmY1x1-rTH\"></iframe>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk5 { color: #A6E22E; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Repeated Method Parameters in Scala","date":"February 28, 2018","subtitle":"Let's see how Scala supports variable arguments and repeated method parameters","description":"Let's see how Scala supports variable arguments and repeated method parameters, and the conditions to consider when using them."}}},{"node":{"excerpt":"Before we begin discussing closures in Scala, let us have a quick look at a function. The function literal bill below accepts only one inputâ€¦","fields":{"slug":"/scala/closures-in-scala/","readingTime":{"text":"2 min read"}},"html":"<p>Before we begin discussing closures in Scala, let us have a quick look at a function. The function literal bill below accepts only one input parameter: <code class=\"language-text\">netBill</code>. However, the function calculates the final bill by adding a service charge to <code class=\"language-text\">netBill</code>.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val bill </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> (netBill</span><span class=\"mtk7\">:</span><span class=\"mtk1\"> Double) </span><span class=\"mtk7\">=&gt;</span><span class=\"mtk1\"> netBill</span><span class=\"mtk7\">*</span><span class=\"mtk1\">(</span><span class=\"mtk4\">1</span><span class=\"mtk1\"> </span><span class=\"mtk7\">+</span><span class=\"mtk1\"> serviceCharge</span><span class=\"mtk7\">/</span><span class=\"mtk4\">100</span><span class=\"mtk1\">)</span></span></span></code></pre>\n<p>So if we try to compile the above function, Scala is going to complain that it does not know anything about <code class=\"language-text\">serviceCharge</code>.</p>\n<p>We have one bounded variable: <code class=\"language-text\">netBill</code>. It is bound to the function call and takes its value from whatever is provided to the function. But <code class=\"language-text\">serviceCharge</code> is a free variable, and the function literal does not provide it with any value.</p>\n<p>In order to execute our function literal, we need to provide a value to <code class=\"language-text\">serviceCharge</code> outside the function <code class=\"language-text\">bill</code>.</p>\n<pre class=\"grvsc-container monokai\" data-language=\"java\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">val serviceCharge </span><span class=\"mtk7\">=</span><span class=\"mtk1\"> </span><span class=\"mtk4\">14</span></span></span></code></pre>\n<p>And now, if we redefine our <code class=\"language-text\">bill</code> function again, then Scala will be quite happy with our declaration.</p>\n<p>The function value created at runtime from this function literal bill is called a closure because we capture the binding of its free variable by closing the function. In the above example, we have captured the value of <code class=\"language-text\">serviceCharge</code> as 14.</p>\n<p>The video tutorial highlights the concept in more detail with few more examples:</p>\n<iframe src=\"https://www.youtube.com/embed/WQOGQ6ytmdw\"></iframe>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .monokai {\n    background-color: #272822;\n    color: #f8f8f2;\n  }\n  .monokai .mtk1 { color: #F8F8F2; }\n  .monokai .mtk7 { color: #F92672; }\n  .monokai .mtk4 { color: #AE81FF; }\n  .monokai .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"title":"Closures in Scala","date":"February 16, 2018","subtitle":"If you're trying Scala out, see how closures work to bind free variables to function literals with some sample code.","description":"This is a quick hands-on tutorial on closures in Scala. It binds free variables to function literals."}}}]},"profilePic":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAMEBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHHSeqLueMtRQX/xAAcEAACAQUBAAAAAAAAAAAAAAABAgMABBESEyL/2gAIAQEAAQUCYdLmSKIKo85UTPMhVbk4amGy6iv/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAcEAEAAQQDAAAAAAAAAAAAAAABAAIQEiERMVH/2gAIAQEABj8CwXUcOciEqXfkSjU6LUrb/8QAGhAAAwEBAQEAAAAAAAAAAAAAAAERITFBUf/aAAgBAQABPyHfCCEr6CmydRIf0JgZ0RVN0OhSRvKIv//aAAwDAQACAAMAAAAQP/jB/8QAFhEBAQEAAAAAAAAAAAAAAAAAEQAQ/9oACAEDAQE/ECN//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAGxABAAMBAQEBAAAAAAAAAAAAAQARITFBgWH/2gAIAQEAAT8Q3XEM2s8g5UFO9b7fKni0OkSXGYXpWfdJcB9qp7ypzMgRSyJu/IFBramp+zaBQNT/2Q==","aspectRatio":1,"src":"/static/d15f09c08a7b6f8c8eee4a58db8ba793/8295c/profile-pic.jpg","srcSet":"/static/d15f09c08a7b6f8c8eee4a58db8ba793/99438/profile-pic.jpg 50w,\n/static/d15f09c08a7b6f8c8eee4a58db8ba793/b315d/profile-pic.jpg 100w,\n/static/d15f09c08a7b6f8c8eee4a58db8ba793/8295c/profile-pic.jpg 200w,\n/static/d15f09c08a7b6f8c8eee4a58db8ba793/1bb83/profile-pic.jpg 283w","sizes":"(max-width: 200px) 100vw, 200px"}}}},"pageContext":{"limit":5,"skip":0,"isFirstPage":true,"isLastPage":false,"currentPage":1,"totalPages":5}},"staticQueryHashes":["786959418","852313850"]}